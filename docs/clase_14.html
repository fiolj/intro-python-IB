<!DOCTYPE html>
<html class="writer-html5" lang="es" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clase 14: Interfaces con otros lenguajes &mdash; documentación de Clases de Python - </title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=0df96459" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=330c1f8c" />
      <link rel="stylesheet" type="text/css" href="_static/rtd_overrides.css?v=5bd222a9" />

  
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=e2bb6099"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/translations.js?v=efdbd0b9"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Búsqueda" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Clases de Python
              <img src="_static/logo.svg" class="logo" alt="Logotipo"/>
          </a>
              <div class="version">
                IB - 2025
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Buscar documentos" aria-label="Buscar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Dictado de las clases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="clase_00.html">Clase 0: Introducción al lenguaje Python orientado a Ingenierías y Física</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_01.html">Clase 1: Introducción al lenguaje</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_02.html">Clase 2: Modularización y tipos compuestos</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_03.html">Clase 3: Tipos complejos y control de flujo</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_04.html">Clase 4: Funciones</a></li>
<li class="toctree-l1"><a class="reference internal" href="clase_04.html#control-de-tipos-estaticos">Control de tipos estáticos</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Ejercicios de Clase</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ejercicios.html">Ejercicios</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="entregas_ejercicios.html">Entrega de ejercicios</a></li>
<li class="toctree-l1"><a class="reference internal" href="programa_detalle.html">Programa Detallado</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Clases de Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Clase 14: Interfaces con otros lenguajes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/clase_14.rst.txt" rel="nofollow"> Ver código fuente de la página</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="clase-14-interfaces-con-otros-lenguajes">
<span id="clase-14"></span><h1>Clase 14: Interfaces con otros lenguajes<a class="headerlink" href="#clase-14-interfaces-con-otros-lenguajes" title="Link to this heading"></a></h1>
<p>A diferencia de <strong>Python</strong>, tanto <strong>Fortran</strong> como <strong>C</strong> y <strong>C++</strong> son
lenguajes <em>compilados</em>: el código fuente tiene que se convertido a un
lenguaje ejecutable para poder ser utilizado. Como mencionamos
anteriormente, esto suele ser muy conveniente en el flujo de
programación usual pero puede haber casos en que el código en Python es
notablemente más lento, o casos en que ya existen rutinas en otros
lenguajes y convertirlas a un nuevo lenguaje sea mucho trabajo. En esos
casos, una solución posible y conveniente es utilizar un lenguaje
compilado para rutinas específicas y Python para todo el resto del
trabajo (entrada/salida, manejo de datos, graficación, etc).</p>
<section id="ejemplo-1-rotacion-de-vectores">
<h2>Ejemplo 1: Rotación de vectores<a class="headerlink" href="#ejemplo-1-rotacion-de-vectores" title="Link to this heading"></a></h2>
<p>Supongamos que queremos resolver el problema de la rotación de vectores
en el espacio usando los <a class="reference external" href="https://mathworld.wolfram.com/EulerAngles.html">tres ángulos de
Euler</a>.</p>
<p>Dado un array con los tres ángulos de Euler, calculamos la matriz de
rotación (de 3 x 3), y la aplicamos (esto es, multiplicamos) a un
arreglo de <em>N</em> vectores.</p>
<p>En una primera versión, podemos hacerlo en Python directamente en el
notebook:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
  <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span>
  <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Ángulos de Euler</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># Definimos N vectores tridimensionales</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre></div>
</div>
<p>Si ya tenemos un módulo donde están programadas las funciones necesarias</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load rotacion_p.py</span>
<span class="c1">#! /usr/bin/ipython3</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
  <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span>
  <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>es fácil utilizarlas:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Ángulos de Euler</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># Definimos N vectores tridimensionales</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">0.06193349</span> <span class="mf">0.99877501</span> <span class="mf">0.79127934</span><span class="p">]</span>
<span class="p">[[</span> <span class="mf">0.90717864</span>  <span class="mf">0.68082735</span> <span class="o">-</span><span class="mf">0.01987772</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.43798584</span>  <span class="mf">0.78786433</span>  <span class="mf">0.54493442</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.75536562</span>  <span class="mf">0.51102298</span>  <span class="mf">0.41541194</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.17681573</span>  <span class="mf">0.1682188</span>  <span class="o">-</span><span class="mf">0.02342615</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.20673471</span>  <span class="mf">0.38302061</span>  <span class="mf">0.17507386</span><span class="p">]]</span>
</pre></div>
</div>
<section id="importando-desde-un-modulo-en-un-archivo">
<h3>Importando desde un módulo en un archivo<a class="headerlink" href="#importando-desde-un-modulo-en-un-archivo" title="Link to this heading"></a></h3>
<p>También podemos tener las funciones para la rotación en un módulo
<code class="docutils literal notranslate"><span class="pre">rotaciones.py</span></code>. Recordemos cómo se importarían en este caso</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pwd</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;/home/fiol/Clases/IntPython/clases-python/clases&#39;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">../</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_python</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">fiol</span><span class="o">/</span><span class="n">Clases</span><span class="o">/</span><span class="n">IntPython</span><span class="o">/</span><span class="n">clases</span><span class="o">-</span><span class="n">python</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_python</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[0m[01;34m__pycache__[0m/  rotaciones.py
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rotaciones</span> <span class="k">as</span> <span class="nn">rotp</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">rotp</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Help</span> <span class="n">on</span> <span class="n">module</span> <span class="n">rotaciones</span><span class="p">:</span>

<span class="n">NAME</span>
    <span class="n">rotaciones</span>

<span class="n">FUNCTIONS</span>
    <span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

    <span class="n">rotate</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="n">FILE</span>
    <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">fiol</span><span class="o">/</span><span class="n">Clases</span><span class="o">/</span><span class="n">IntPython</span><span class="o">/</span><span class="n">clases</span><span class="o">-</span><span class="n">python</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_python</span><span class="o">/</span><span class="n">rotaciones</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yp</span> <span class="o">=</span> <span class="n">rotp</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">yp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span> <span class="mf">0.90717864</span>  <span class="mf">0.68082735</span> <span class="o">-</span><span class="mf">0.01987772</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.43798584</span>  <span class="mf">0.78786433</span>  <span class="mf">0.54493442</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.75536562</span>  <span class="mf">0.51102298</span>  <span class="mf">0.41541194</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.17681573</span>  <span class="mf">0.1682188</span>  <span class="o">-</span><span class="mf">0.02342615</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.20673471</span>  <span class="mf">0.38302061</span>  <span class="mf">0.17507386</span><span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kc">True</span>
</pre></div>
</div>
</section>
</section>
<section id="interfaces-con-fortran">
<h2>Interfaces con Fortran<a class="headerlink" href="#interfaces-con-fortran" title="Link to this heading"></a></h2>
<p>Veamos cómo trabajar si tenemos el código para realizar las rotaciones
en Fortran</p>
<section id="primer-ejemplo-nuestro-codigo">
<h3>Primer ejemplo: Nuestro código<a class="headerlink" href="#primer-ejemplo-nuestro-codigo" title="Link to this heading"></a></h3>
<p>El código en Fortran que tenemos es:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">function </span><span class="n">rotate</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">N</span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">theta</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cx</span><span class="p">,</span><span class="w"> </span><span class="n">cy</span><span class="p">,</span><span class="w"> </span><span class="n">cz</span><span class="p">,</span><span class="w"> </span><span class="n">sx</span><span class="p">,</span><span class="w"> </span><span class="n">sy</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span>

<span class="w">  </span><span class="c">! Senos y Cosenos de los tres ángulos de Euler</span>
<span class="w">  </span><span class="n">cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="n">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="n">cz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="w">  </span><span class="n">sx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="n">sy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"> </span><span class="n">sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="w">  </span><span class="c">! Matriz de rotación</span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">cz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sx</span><span class="o">*</span><span class="n">cy</span><span class="o">*</span><span class="n">sz</span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">sz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sx</span><span class="o">*</span><span class="n">cy</span><span class="o">*</span><span class="n">cz</span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sx</span><span class="o">*</span><span class="n">sy</span>

<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sx</span><span class="o">*</span><span class="n">cz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">cy</span><span class="o">*</span><span class="n">sz</span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sx</span><span class="o">*</span><span class="n">sz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">cy</span><span class="o">*</span><span class="n">cz</span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cx</span><span class="o">*</span><span class="n">sy</span>

<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sy</span><span class="o">*</span><span class="n">sz</span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">sy</span><span class="o">*</span><span class="n">cz</span>
<span class="w">  </span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cy</span>

<span class="w">  </span><span class="c">! Aplicamos la rotación</span>
<span class="w">  </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span>
<span class="k">end function </span><span class="n">rotate</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">../</span><span class="n">interfacing_F</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">fiol</span><span class="o">/</span><span class="n">Clases</span><span class="o">/</span><span class="n">IntPython</span><span class="o">/</span><span class="n">clases</span><span class="o">-</span><span class="n">python</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_F</span>
</pre></div>
</div>
</section>
<section id="f2py">
<h3>F2PY<a class="headerlink" href="#f2py" title="Link to this heading"></a></h3>
<p>F2PY -Fortran to Python interface generator- es una utilidad que permite
generar una interface para utilizar funciones y datos definidos en
Fortran desde Python.</p>
<p>Información sobre la interfaz entre Fotran y Python, y en particular
sobre F2PY, puede encontrarse en:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://scipy-cookbook.readthedocs.io/items/idx_interfacing_with_other_languages.html">Scipy
cookbook</a></p></li>
<li><p><a class="reference external" href="https://docs.scipy.org/doc/numpy-dev/f2py/index.html">F2PY Users Guide and Reference
Manual</a></p></li>
<li><p><a class="reference external" href="http://www.fortran90.org/src/best-practices.html#interfacing-with-python">Fortran Best
Practices</a></p></li>
<li><p><a class="reference external" href="http://websrv.cs.umt.edu/isis/index.php/F2py_example">http://websrv.cs.umt.edu/isis/index.php/F2py_example</a></p></li>
</ul>
<p>El primer paso es utilizar esta utilidad:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>f2py3<span class="w"> </span>-c<span class="w"> </span>rotacion.f90<span class="w"> </span>-m<span class="w"> </span>rotacion_f
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">f2py3</span> <span class="o">-</span><span class="n">c</span> <span class="n">rotacion</span><span class="o">.</span><span class="n">f90</span> <span class="o">-</span><span class="n">m</span> <span class="n">rotacion_f</span>
</pre></div>
</div>
<pre class="literal-block">[39mrunning build[0m
[39mrunning config_cc[0m
[39mINFO: unifing config_cc, config, build_clib, build_ext, build commands --compiler options[0m
[39mrunning config_fc[0m
[39mINFO: unifing config_fc, config, build_clib, build_ext, build commands --fcompiler options[0m
[39mrunning build_src[0m
[39mINFO: build_src[0m
[39mINFO: building extension &quot;rotacion_f&quot; sources[0m
[39mINFO: f2py options: [][0m
[39mINFO: f2py:&gt; /tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_fmodule.c[0m
[39mcreating /tmp/tmp8o0oz7vs/src.linux-x86_64-3.11[0m
Reading fortran codes...
    Reading file 'rotacion.f90' (format:free)
Post-processing...
    Block: rotacion_f
                    Block: rotaciones
                            Block: matrix_rotation
appenddecl: &quot;dimension&quot; not implemented.
                            Block: rotate
appenddecl: &quot;dimension&quot; not implemented.
                    Block: test_rotation
Applying post-processing hooks...
  character_backward_compatibility_hook
Post-processing (stage 2)...
    Block: rotacion_f
            Block: unknown_interface
                    Block: rotaciones
                            Block: matrix_rotation
                            Block: rotate
                    Block: test_rotation
Building modules...
    Building module &quot;rotacion_f&quot;...
            Constructing F90 module support for &quot;rotaciones&quot;...
            Creating wrapper for Fortran function &quot;matrix_rotation&quot;(&quot;matrix_rotation&quot;)...
            Constructing wrapper function &quot;rotaciones.matrix_rotation&quot;...
              r = matrix_rotation(angles)
            Creating wrapper for Fortran function &quot;rotate&quot;(&quot;rotate&quot;)...
            Constructing wrapper function &quot;rotaciones.rotate&quot;...
              y = rotate(angles,v,[n])
    Wrote C/API module &quot;rotacion_f&quot; to file &quot;/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_fmodule.c&quot;
    Fortran 90 wrappers are saved to &quot;/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_f-f2pywrappers2.f90&quot;
[39mINFO:   adding '/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/fortranobject.c' to sources.[0m
[39mINFO:   adding '/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11' to include_dirs.[0m
[39mcopying /usr/lib64/python3.11/site-packages/numpy/f2py/src/fortranobject.c -&gt; /tmp/tmp8o0oz7vs/src.linux-x86_64-3.11[0m
[39mcopying /usr/lib64/python3.11/site-packages/numpy/f2py/src/fortranobject.h -&gt; /tmp/tmp8o0oz7vs/src.linux-x86_64-3.11[0m
[39mINFO:   adding '/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_f-f2pywrappers2.f90' to sources.[0m
[39mINFO: build_src: building npy-pkg config files[0m
/home/fiol/.local/lib/python3.11/site-packages/setuptools/_distutils/cmd.py:66: SetuptoolsDeprecationWarning: setup.py install is deprecated.
!!

        <strong>****************************************************************************</strong>
        Please avoid running <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> directly.
        Instead, use pypa/build, pypa/installer or other
        standards-based tools.

        See <a class="reference external" href="https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html">https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html</a> for details.
        <strong>****************************************************************************</strong>

!!
  self.initialize_options()
[39mrunning build_ext[0m
[39mINFO: customize UnixCCompiler[0m
[39mINFO: customize UnixCCompiler using build_ext[0m
[39mINFO: get_default_fcompiler: matching types: '['arm', 'gnu95', 'intel', 'lahey', 'pg', 'nv', 'absoft', 'nag', 'vast', 'compaq', 'intele', 'intelem', 'gnu', 'g95', 'pathf95', 'nagfor', 'fujitsu']'[0m
[39mINFO: customize ArmFlangCompiler[0m
[31mWARN: Could not locate executable armflang[0m
[39mINFO: customize Gnu95FCompiler[0m
[39mINFO: Found executable /usr/bin/gfortran[0m
[39mINFO: customize Gnu95FCompiler[0m
[39mINFO: customize Gnu95FCompiler using build_ext[0m
[39mINFO: building 'rotacion_f' extension[0m
[39mINFO: compiling C sources[0m
[39mINFO: C compiler: gcc -Wsign-compare -DDYNAMIC_ANNOTATIONS_ENABLED=1 -DNDEBUG -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-U_FORTIFY_SOURCE,-D_FORTIFY_SOURCE=3 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-U_FORTIFY_SOURCE,-D_FORTIFY_SOURCE=3 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-U_FORTIFY_SOURCE,-D_FORTIFY_SOURCE=3 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -fPIC
[0m
[39mcreating /tmp/tmp8o0oz7vs/tmp[0m
[39mcreating /tmp/tmp8o0oz7vs/tmp/tmp8o0oz7vs[0m
[39mcreating /tmp/tmp8o0oz7vs/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11[0m
[39mINFO: compile options: '-DNPY_DISABLE_OPTIMIZATION=1 -I/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11 -I/usr/lib64/python3.11/site-packages/numpy/core/include -I/usr/include/python3.11 -c'[0m
[39mINFO: gcc: /tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_fmodule.c[0m
[39mINFO: gcc: /tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/fortranobject.c[0m
[39mINFO: compiling Fortran 90 module sources[0m
[39mINFO: Fortran f77 compiler: /usr/bin/gfortran -Wall -g -ffixed-form -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran f90 compiler: /usr/bin/gfortran -Wall -g -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran fix compiler: /usr/bin/gfortran -Wall -g -ffixed-form -fno-second-underscore -Wall -g -fno-second-underscore -fPIC -O3 -funroll-loops[0m
[39mINFO: compile options: '-I/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11 -I/usr/lib64/python3.11/site-packages/numpy/core/include -I/usr/include/python3.11 -c'
extra options: '-J/tmp/tmp8o0oz7vs/ -I/tmp/tmp8o0oz7vs/'[0m
[39mINFO: gfortran:f90: rotacion.f90[0m
[01m[Krotacion.f90:56:24:[m[K

   56 |   integer :: n, Nloops,i,j
      |                        [01;35m[K1[m[K
[01;35m[KWarning:[m[K Unused variable ‘[01m[Ki[m[K’ declared at [01;35m[K(1)[m[K [[01;35m[K]8;;https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wunused-variable-Wunused-variable]8;;[m[K]
[01m[Krotacion.f90:56:26:[m[K

   56 |   integer :: n, Nloops,i,j
      |                          [01;35m[K1[m[K
[01;35m[KWarning:[m[K Unused variable ‘[01m[Kj[m[K’ declared at [01;35m[K(1)[m[K [[01;35m[K]8;;https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wunused-variable-Wunused-variable]8;;[m[K]
[01m[Krotacion.f90:59:31:[m[K

   59 |   real(8), dimension(3, 3) :: R
      |                               [01;35m[K1[m[K
[01;35m[KWarning:[m[K Unused variable ‘[01m[Kr[m[K’ declared at [01;35m[K(1)[m[K [[01;35m[K]8;;https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wunused-variable-Wunused-variable]8;;[m[K]
[01m[Krotacion.f90:44:42:[m[K

   44 |     y = matmul(matrix_rotation(angles), v)
      |                                          [01;35m[K^[m[K
[01;35m[KWarning:[m[K ‘[01m[K__var_1_mma.offset[m[K’ is used uninitialized [[01;35m[K]8;;https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wuninitialized-Wuninitialized]8;;[m[K]
[01m[Krotacion.f90:47:21:[m[K

   47 | end module rotaciones
      |                     [01;36m[K^[m[K
[01;36m[Knote:[m[K ‘[01m[K__var_1_mma[m[K’ declared here
[01m[Krotacion.f90:44:42:[m[K

   44 |     y = matmul(matrix_rotation(angles), v)
      |                                          [01;35m[K^[m[K
[01;35m[KWarning:[m[K ‘[01m[K__var_1_mma.dim[0].lbound[m[K’ is used uninitialized [[01;35m[K]8;;https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wuninitialized-Wuninitialized]8;;[m[K]
[01m[Krotacion.f90:47:21:[m[K

   47 | end module rotaciones
      |                     [01;36m[K^[m[K
[01;36m[Knote:[m[K ‘[01m[K__var_1_mma[m[K’ declared here
[01m[Krotacion.f90:44:42:[m[K

   44 |     y = matmul(matrix_rotation(angles), v)
      |                                          [01;35m[K^[m[K
[01;35m[KWarning:[m[K ‘[01m[K__var_1_mma.dim[0].ubound[m[K’ is used uninitialized [[01;35m[K]8;;https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wuninitialized-Wuninitialized]8;;[m[K]
[01m[Krotacion.f90:47:21:[m[K

   47 | end module rotaciones
      |                     [01;36m[K^[m[K
[01;36m[Knote:[m[K ‘[01m[K__var_1_mma[m[K’ declared here
[01m[Krotacion.f90:44:42:[m[K

   44 |     y = matmul(matrix_rotation(angles), v)
      |                                          [01;35m[K^[m[K
[01;35m[KWarning:[m[K ‘[01m[K__var_1_mma.dim[1].lbound[m[K’ is used uninitialized [[01;35m[K]8;;https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wuninitialized-Wuninitialized]8;;[m[K]
[01m[Krotacion.f90:47:21:[m[K

   47 | end module rotaciones
      |                     [01;36m[K^[m[K
[01;36m[Knote:[m[K ‘[01m[K__var_1_mma[m[K’ declared here
[01m[Krotacion.f90:44:42:[m[K

   44 |     y = matmul(matrix_rotation(angles), v)
      |                                          [01;35m[K^[m[K
[01;35m[KWarning:[m[K ‘[01m[K__var_1_mma.dim[1].ubound[m[K’ is used uninitialized [[01;35m[K]8;;https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wuninitialized-Wuninitialized]8;;[m[K]
[01m[Krotacion.f90:47:21:[m[K

   47 | end module rotaciones
      |                     [01;36m[K^[m[K
[01;36m[Knote:[m[K ‘[01m[K__var_1_mma[m[K’ declared here
[39mINFO: compiling Fortran sources[0m
[39mINFO: Fortran f77 compiler: /usr/bin/gfortran -Wall -g -ffixed-form -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran f90 compiler: /usr/bin/gfortran -Wall -g -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran fix compiler: /usr/bin/gfortran -Wall -g -ffixed-form -fno-second-underscore -Wall -g -fno-second-underscore -fPIC -O3 -funroll-loops[0m
[39mINFO: compile options: '-I/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11 -I/usr/lib64/python3.11/site-packages/numpy/core/include -I/usr/include/python3.11 -c'
extra options: '-J/tmp/tmp8o0oz7vs/ -I/tmp/tmp8o0oz7vs/'[0m
[39mINFO: gfortran:f90: /tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_f-f2pywrappers2.f90[0m
[01m[K/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_f-f2pywrappers2.f90:5:52:[m[K

    5 |       subroutine f2pywrap_rotaciones_matrix_rotation (matrix_rotationf2p&amp;
      |                                                    [01;35m[K1[m[K
......
   24 |       subroutine f2pywrap_rotaciones_matrix_rotation (matrix_rotationf2p&amp;
      |                                                    [32m[K2[m[K
[01;35m[KWarning:[m[K Rank mismatch in argument 'matrix_rotation' (2/1) between [01;35m[K(1)[m[K and [32m[K(2)[m[K
[01m[K/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_f-f2pywrappers2.f90:12:43:[m[K

   12 |       subroutine f2pywrap_rotaciones_rotate (rotatef2pywrap, angles, v, &amp;
      |                                           [01;35m[K1[m[K
......
   30 |       subroutine f2pywrap_rotaciones_rotate (rotatef2pywrap, rotate, ang&amp;
      |                                           [32m[K2[m[K
[01;35m[KWarning:[m[K Rank mismatch in argument 'rotate' (2/1) between [01;35m[K(1)[m[K and [32m[K(2)[m[K
[39mINFO: /usr/bin/gfortran -Wall -g -Wall -g -shared /tmp/tmp8o0oz7vs/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_fmodule.o /tmp/tmp8o0oz7vs/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/fortranobject.o /tmp/tmp8o0oz7vs/rotacion.o /tmp/tmp8o0oz7vs/tmp/tmp8o0oz7vs/src.linux-x86_64-3.11/rotacion_f-f2pywrappers2.o -L/usr/lib/gcc/x86_64-redhat-linux/13 -L/usr/lib/gcc/x86_64-redhat-linux/13 -L/usr/lib64 -lgfortran -o ./rotacion_f.cpython-311-x86_64-linux-gnu.so[0m
Removing build directory /tmp/tmp8o0oz7vs</pre>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rotacion_f</span> <span class="kn">import</span> <span class="n">rotaciones</span> <span class="k">as</span> <span class="n">rotf</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yf</span> <span class="o">=</span> <span class="n">rotf</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yf</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">yf</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span> <span class="mf">0.90717864</span>  <span class="mf">0.68082735</span> <span class="o">-</span><span class="mf">0.01987772</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.43798584</span>  <span class="mf">0.78786433</span>  <span class="mf">0.54493442</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.75536562</span>  <span class="mf">0.51102298</span>  <span class="mf">0.41541194</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.17681573</span>  <span class="mf">0.1682188</span>  <span class="o">-</span><span class="mf">0.02342615</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.20673471</span>  <span class="mf">0.38302061</span>  <span class="mf">0.17507386</span><span class="p">]]</span>
<span class="p">[[</span> <span class="mf">0.90717864</span>  <span class="mf">0.68082735</span> <span class="o">-</span><span class="mf">0.01987772</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.43798584</span>  <span class="mf">0.78786433</span>  <span class="mf">0.54493442</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.75536562</span>  <span class="mf">0.51102298</span>  <span class="mf">0.41541194</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.17681573</span>  <span class="mf">0.1682188</span>  <span class="o">-</span><span class="mf">0.02342615</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.20673471</span>  <span class="mf">0.38302061</span>  <span class="mf">0.17507386</span><span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kc">True</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">timeit</span> <span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>6.42 µs ± 107 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">timeit</span> <span class="n">rotf</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2.48 µs ± 24.2 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)
</pre></div>
</div>
<p>Veamos qué es exactamente lo que importamos:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">rotf</span><span class="o">.</span><span class="n">rotate</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">y = rotate(angles,v,[n])

Wrapper for <code class="docutils literal notranslate"><span class="pre">rotate</span></code>.

Parameters
----------
angles : input rank-1 array('d') with bounds (3)
v : input rank-2 array('d') with bounds (3,n)

Other Parameters
----------------
n : input int, optional
    Default: shape(v, 1)

Returns
-------
y : rank-2 array('d') with bounds (3,n) and rotate storage</pre>
<p>Como vemos, estamos usando la función <code class="docutils literal notranslate"><span class="pre">rotate</span></code> definida en Fortran.
Notar que: * Tiene tres argumentos. * Dos argumentos requeridos:
<code class="docutils literal notranslate"><span class="pre">angles</span></code> y <code class="docutils literal notranslate"><span class="pre">v</span></code> * Un argumento, correspondiente a la dimensión <code class="docutils literal notranslate"><span class="pre">n</span></code>
que F2PY automáticamente detecta como opcional.</p>
</section>
<section id="segundo-ejemplo-codigo-heredado">
<h3>Segundo Ejemplo: Código heredado<a class="headerlink" href="#segundo-ejemplo-codigo-heredado" title="Link to this heading"></a></h3>
<p>La conversión que realizamos con f2py3 la podríamos haber realizado en
dos pasos:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>f2py3<span class="w"> </span>rotacion.f90<span class="w"> </span>-m<span class="w"> </span>rotacion_f<span class="w"> </span>-h<span class="w"> </span>rotacion.pyf
$<span class="w"> </span>f2py3<span class="w"> </span>-c<span class="w"> </span>rotacion.pyf<span class="w"> </span>-m<span class="w"> </span>rotacion_f
</pre></div>
</div>
<p>En el primer paso se crea un archivo <em>signature</em> que después se utiliza
para crear el módulo que llamaremos desde <strong>Python</strong>. Haciéndolo en dos
pasos nos permite modificar el texto del archivo <em>.pyf</em> antes de
ejecutar el segundo comando.</p>
<p>Esto es útil cuando el código original no es lo suficientemente
“moderno”, no tiene toda la información necesaria sobre los argumentos o
es un código que uno no quiere o puede editar. Veamos que forma tienen
con un ejemplo más simple (tomado de la <a class="reference external" href="https://docs.scipy.org/doc/numpy-dev/f2py/getting-started.html">guía de
usuario</a>):</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="k">SUBROUTINE </span><span class="n">FIB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="n">C</span>
<span class="n">C</span><span class="w">     </span><span class="n">CALCULATE</span><span class="w"> </span><span class="n">FIRST</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">FIBONACCI</span><span class="w"> </span><span class="n">NUMBERS</span>
<span class="n">C</span>
<span class="w">      </span><span class="kt">INTEGER </span><span class="n">N</span>
<span class="w">      </span><span class="kt">REAL</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="w">      </span><span class="k">DO </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">         </span><span class="k">ELSEIF</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="w">         </span><span class="k">ELSE</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="w">         </span><span class="k">ENDIF</span>
<span class="k">      ENDDO</span>
<span class="k">      END</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">f2py3</span> <span class="o">--</span><span class="n">overwrite</span><span class="o">-</span><span class="n">signature</span> <span class="n">fib1</span><span class="o">.</span><span class="n">f</span> <span class="o">-</span><span class="n">m</span> <span class="n">fib1</span> <span class="o">-</span><span class="n">h</span> <span class="n">fib1</span><span class="o">.</span><span class="n">pyf</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Reading</span> <span class="n">fortran</span> <span class="n">codes</span><span class="o">...</span>
    <span class="n">Reading</span> <span class="n">file</span> <span class="s1">&#39;fib1.f&#39;</span> <span class="p">(</span><span class="nb">format</span><span class="p">:</span><span class="n">fix</span><span class="p">,</span><span class="n">strict</span><span class="p">)</span>
<span class="n">Post</span><span class="o">-</span><span class="n">processing</span><span class="o">...</span>
    <span class="n">Block</span><span class="p">:</span> <span class="n">fib1</span>
                    <span class="n">Block</span><span class="p">:</span> <span class="n">fib</span>
<span class="n">Applying</span> <span class="n">post</span><span class="o">-</span><span class="n">processing</span> <span class="n">hooks</span><span class="o">...</span>
  <span class="n">character_backward_compatibility_hook</span>
<span class="n">Post</span><span class="o">-</span><span class="n">processing</span> <span class="p">(</span><span class="n">stage</span> <span class="mi">2</span><span class="p">)</span><span class="o">...</span>
<span class="n">Saving</span> <span class="n">signatures</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;./fib1.pyf&quot;</span>
</pre></div>
</div>
<p>El contenido del archivo <code class="docutils literal notranslate"><span class="pre">fib1.pyf</span></code> es:</p>
<div class="highlight-fortran90 notranslate"><div class="highlight"><pre><span></span>python module fib1 ! in
    interface  ! in :fib1
        subroutine fib(a,n) ! in :fib1:fib1.f
            real*8 dimension(n) :: a
            integer, optional,check(len(a)&gt;=n),depend(a) :: n=len(a)
        end subroutine fib
    end interface
end python module fib1
</pre></div>
</div>
<p>Este código indica que tenemos una subrutina que toma dos argumentos: -
<code class="docutils literal notranslate"><span class="pre">a</span></code> es un array - <code class="docutils literal notranslate"><span class="pre">n</span></code> es un entero opcional, que tiene que ser mayor
que <code class="docutils literal notranslate"><span class="pre">len(a)</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">f2py3</span>  <span class="o">-</span><span class="n">c</span> <span class="n">fib1</span><span class="o">.</span><span class="n">pyf</span> <span class="n">fib1</span><span class="o">.</span><span class="n">f</span>
</pre></div>
</div>
<pre class="literal-block">[39mrunning build[0m
[39mrunning config_cc[0m
[39mINFO: unifing config_cc, config, build_clib, build_ext, build commands --compiler options[0m
[39mrunning config_fc[0m
[39mINFO: unifing config_fc, config, build_clib, build_ext, build commands --fcompiler options[0m
[39mrunning build_src[0m
[39mINFO: build_src[0m
[39mINFO: building extension &quot;fib1&quot; sources[0m
[39mcreating /tmp/tmpvzr316vv/src.linux-x86_64-3.11[0m
[39mINFO: f2py options: [][0m
[39mINFO: f2py: fib1.pyf[0m
Reading fortran codes...
    Reading file 'fib1.pyf' (format:free)
Post-processing...
    Block: fib1
                    Block: fib
Applying post-processing hooks...
  character_backward_compatibility_hook
Post-processing (stage 2)...
Building modules...
    Building module &quot;fib1&quot;...
    Generating possibly empty wrappers&quot;
    Maybe empty &quot;fib1-f2pywrappers.f&quot;
        Constructing wrapper function &quot;fib&quot;...
          fib(a,[n])
    Wrote C/API module &quot;fib1&quot; to file &quot;/tmp/tmpvzr316vv/src.linux-x86_64-3.11/fib1module.c&quot;
[39mINFO:   adding '/tmp/tmpvzr316vv/src.linux-x86_64-3.11/fortranobject.c' to sources.[0m
[39mINFO:   adding '/tmp/tmpvzr316vv/src.linux-x86_64-3.11' to include_dirs.[0m
[39mcopying /usr/lib64/python3.11/site-packages/numpy/f2py/src/fortranobject.c -&gt; /tmp/tmpvzr316vv/src.linux-x86_64-3.11[0m
[39mcopying /usr/lib64/python3.11/site-packages/numpy/f2py/src/fortranobject.h -&gt; /tmp/tmpvzr316vv/src.linux-x86_64-3.11[0m
[39mINFO:   adding '/tmp/tmpvzr316vv/src.linux-x86_64-3.11/fib1-f2pywrappers.f' to sources.[0m
[39mINFO: build_src: building npy-pkg config files[0m
/home/fiol/.local/lib/python3.11/site-packages/setuptools/_distutils/cmd.py:66: SetuptoolsDeprecationWarning: setup.py install is deprecated.
!!

        <strong>****************************************************************************</strong>
        Please avoid running <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> directly.
        Instead, use pypa/build, pypa/installer or other
        standards-based tools.

        See <a class="reference external" href="https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html">https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html</a> for details.
        <strong>****************************************************************************</strong>

!!
  self.initialize_options()
[39mrunning build_ext[0m
[39mINFO: customize UnixCCompiler[0m
[39mINFO: customize UnixCCompiler using build_ext[0m
[39mINFO: get_default_fcompiler: matching types: '['arm', 'gnu95', 'intel', 'lahey', 'pg', 'nv', 'absoft', 'nag', 'vast', 'compaq', 'intele', 'intelem', 'gnu', 'g95', 'pathf95', 'nagfor', 'fujitsu']'[0m
[39mINFO: customize ArmFlangCompiler[0m
[31mWARN: Could not locate executable armflang[0m
[39mINFO: customize Gnu95FCompiler[0m
[39mINFO: Found executable /usr/bin/gfortran[0m
[39mINFO: customize Gnu95FCompiler[0m
[39mINFO: customize Gnu95FCompiler using build_ext[0m
[39mINFO: building 'fib1' extension[0m
[39mINFO: compiling C sources[0m
[39mINFO: C compiler: gcc -Wsign-compare -DDYNAMIC_ANNOTATIONS_ENABLED=1 -DNDEBUG -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-U_FORTIFY_SOURCE,-D_FORTIFY_SOURCE=3 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-U_FORTIFY_SOURCE,-D_FORTIFY_SOURCE=3 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-U_FORTIFY_SOURCE,-D_FORTIFY_SOURCE=3 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -fPIC
[0m
[39mcreating /tmp/tmpvzr316vv/tmp[0m
[39mcreating /tmp/tmpvzr316vv/tmp/tmpvzr316vv[0m
[39mcreating /tmp/tmpvzr316vv/tmp/tmpvzr316vv/src.linux-x86_64-3.11[0m
[39mINFO: compile options: '-DNPY_DISABLE_OPTIMIZATION=1 -I/tmp/tmpvzr316vv/src.linux-x86_64-3.11 -I/usr/lib64/python3.11/site-packages/numpy/core/include -I/usr/include/python3.11 -c'[0m
[39mINFO: gcc: /tmp/tmpvzr316vv/src.linux-x86_64-3.11/fib1module.c[0m
[39mINFO: gcc: /tmp/tmpvzr316vv/src.linux-x86_64-3.11/fortranobject.c[0m
[39mINFO: compiling Fortran sources[0m
[39mINFO: Fortran f77 compiler: /usr/bin/gfortran -Wall -g -ffixed-form -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran f90 compiler: /usr/bin/gfortran -Wall -g -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran fix compiler: /usr/bin/gfortran -Wall -g -ffixed-form -fno-second-underscore -Wall -g -fno-second-underscore -fPIC -O3 -funroll-loops[0m
[39mINFO: compile options: '-I/tmp/tmpvzr316vv/src.linux-x86_64-3.11 -I/usr/lib64/python3.11/site-packages/numpy/core/include -I/usr/include/python3.11 -c'[0m
[39mINFO: gfortran:f77: fib1.f[0m
[39mINFO: gfortran:f77: /tmp/tmpvzr316vv/src.linux-x86_64-3.11/fib1-f2pywrappers.f[0m
[39mINFO: /usr/bin/gfortran -Wall -g -Wall -g -shared /tmp/tmpvzr316vv/tmp/tmpvzr316vv/src.linux-x86_64-3.11/fib1module.o /tmp/tmpvzr316vv/tmp/tmpvzr316vv/src.linux-x86_64-3.11/fortranobject.o /tmp/tmpvzr316vv/fib1.o /tmp/tmpvzr316vv/tmp/tmpvzr316vv/src.linux-x86_64-3.11/fib1-f2pywrappers.o -L/usr/lib/gcc/x86_64-redhat-linux/13 -L/usr/lib/gcc/x86_64-redhat-linux/13 -L/usr/lib64 -lgfortran -o ./fib1.cpython-311-x86_64-linux-gnu.so[0m
Removing build directory /tmp/tmpvzr316vv</pre>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">-</span><span class="n">ltr</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>total 780
drwxr-xr-x. 1 fiol fiol     16 mar 27  2023 [0m[01;34mfib2.cpython-39-darwin.so.dSYM[0m/
drwxr-xr-x. 1 fiol fiol     16 mar 27  2023 [01;34mfib3.cpython-39-darwin.so.dSYM[0m/
-rwxr-xr-x. 1 fiol fiol  55448 mar 27  2023 [01;32mfib3.cpython-39-darwin.so[0m*
-rw-r--r--. 1 fiol fiol    403 mar 27  2023 fib2.pyf
-rwxr-xr-x. 1 fiol fiol  55448 mar 27  2023 [01;32mfib2.cpython-39-darwin.so[0m*
-rw-r--r--. 1 fiol fiol    347 mar 27  2023 fib1.f
-rwxr-xr-x. 1 fiol fiol  55512 mar 27  2023 [01;32mfib1.cpython-39-darwin.so[0m*
-rw-r--r--. 1 fiol fiol   1007 mar 27  2023 rotacion.pyf
-rwxr-xr-x. 1 fiol fiol  58480 mar 27  2023 [01;32mrotacion_f.cpython-39-darwin.so[0m*
-rw-r--r--. 1 fiol fiol   2202 mar 27  2023 rotacion.f90
-rw-r--r--. 1 fiol fiol    558 mar 27  2023 rotaciones.mod
-rw-r--r--. 1 fiol fiol    372 mar 27  2023 fib3.f
-rwxr-xr-x. 1 fiol fiol 124216 mar 22 13:27 [01;32mfib2.cpython-311-x86_64-linux-gnu.so[0m*
-rwxr-xr-x. 1 fiol fiol 124216 mar 22 13:28 [01;32mfib3.cpython-311-x86_64-linux-gnu.so[0m*
-rwxr-xr-x. 1 fiol fiol 151944 mar 22 14:28 [01;32mrotacion_f.cpython-311-x86_64-linux-gnu.so[0m*
-rw-r--r--. 1 fiol fiol    501 mar 22 14:41 fib1.pyf
-rwxr-xr-x. 1 fiol fiol 125040 mar 22 14:43 [01;32mfib1.cpython-311-x86_64-linux-gnu.so[0m*
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fib1</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">fib(a,[n])

Wrapper for <code class="docutils literal notranslate"><span class="pre">fib</span></code>.

Parameters
----------
a : input rank-1 array('d') with bounds (n)

Other Parameters
----------------
n : input int, optional
    Default: shape(a, 0)</pre>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="mf">0.</span>  <span class="mf">1.</span>  <span class="mf">1.</span>  <span class="mf">2.</span>  <span class="mf">3.</span>  <span class="mf">5.</span>  <span class="mf">8.</span> <span class="mf">13.</span> <span class="mf">21.</span> <span class="mf">34.</span> <span class="mf">55.</span> <span class="mf">89.</span><span class="p">]</span>
</pre></div>
</div>
<p>Podemos darle además a la función <code class="docutils literal notranslate"><span class="pre">fib</span></code> el argumento opcional <code class="docutils literal notranslate"><span class="pre">n</span></code>.
Solo que debe cumplir la condición especificada en el archivo <em>fib1.pyf</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="mf">0.</span>  <span class="mf">1.</span>  <span class="mf">1.</span>  <span class="mf">2.</span>  <span class="mf">3.</span>  <span class="mf">5.</span>  <span class="mf">8.</span> <span class="mf">13.</span> <span class="mf">21.</span> <span class="mf">34.</span> <span class="mf">55.</span> <span class="mf">89.</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">error</span>                                     <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
      <span class="mi">1</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="o">----&gt;</span> <span class="mi">2</span> <span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
      <span class="mi">3</span> <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="n">error</span><span class="p">:</span> <span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="n">failed</span> <span class="k">for</span> <span class="mi">1</span><span class="n">st</span> <span class="n">keyword</span> <span class="n">n</span><span class="p">:</span> <span class="n">fib</span><span class="p">:</span><span class="n">n</span><span class="o">=</span><span class="mi">8</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">error</span>                                     <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
      <span class="mi">1</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="o">----&gt;</span> <span class="mi">2</span> <span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span>
      <span class="mi">3</span> <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="n">error</span><span class="p">:</span> <span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="n">failed</span> <span class="k">for</span> <span class="mi">1</span><span class="n">st</span> <span class="n">keyword</span> <span class="n">n</span><span class="p">:</span> <span class="n">fib</span><span class="p">:</span><span class="n">n</span><span class="o">=</span><span class="mi">18</span>
</pre></div>
</div>
<p>Esta es una de las características de F2PY: hace un chequeo básico de
los argumentos. Hay otro error que no llega a atrapar: Si le pasamos un
array que no es del tipo indicado, falla (sin avisar). Éste claramente
no es el comportamiento deseado:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">fib1</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Vamos a modificar el archivo de <em>signature</em> para enseñarle dos cosas:</p>
<ul class="simple">
<li><p>El entero es un argumento de entrada (requerido)</p></li>
<li><p>El <em>array</em> <code class="docutils literal notranslate"><span class="pre">a</span></code> es un archivo de salida <strong>exclusivamente</strong>. Entonces
no debemos dárselo. La parte <code class="docutils literal notranslate"><span class="pre">dimension(n)</span></code> y <code class="docutils literal notranslate"><span class="pre">depend(n)</span></code> indica
que debe crear un vector de ese tamaño.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">f2py3</span>  <span class="o">-</span><span class="n">c</span> <span class="n">fib2</span><span class="o">.</span><span class="n">pyf</span> <span class="n">fib1</span><span class="o">.</span><span class="n">f</span> <span class="mi">1</span><span class="o">&amp;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fib2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fib2</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">a = fib(n)

Wrapper for <code class="docutils literal notranslate"><span class="pre">fib</span></code>.

Parameters
----------
n : input int

Returns
-------
a : rank-1 array('d') with bounds (n)</pre>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fib2</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">,</span>  <span class="mf">3.</span><span class="p">,</span>  <span class="mf">5.</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">,</span> <span class="mf">13.</span><span class="p">,</span> <span class="mf">21.</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fib2</span><span class="o">.</span><span class="n">fib</span><span class="p">(</span><span class="mi">14</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>  <span class="mf">0.</span>   <span class="mf">1.</span>   <span class="mf">1.</span>   <span class="mf">2.</span>   <span class="mf">3.</span>   <span class="mf">5.</span>   <span class="mf">8.</span>  <span class="mf">13.</span>  <span class="mf">21.</span>  <span class="mf">34.</span>  <span class="mf">55.</span>  <span class="mf">89.</span> <span class="mf">144.</span> <span class="mf">233.</span><span class="p">]</span>
</pre></div>
</div>
<p>La segunda manera de arreglar este problema, en lugar de modificar el
archivo de <em>signature</em> podría haber sido modificar el código (o hacer
una rutina intermedia). Agregando comentarios de la forma <code class="docutils literal notranslate"><span class="pre">Cf2py</span></code> no
influimos en la compilación <code class="docutils literal notranslate"><span class="pre">Fortran</span></code> pero F2PY los reconoce. En este
caso le damos la información sobre la intención de los argumentos en el
código:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="k">SUBROUTINE </span><span class="n">FIB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<span class="n">C</span>
<span class="n">C</span><span class="w">     </span><span class="n">CALCULATE</span><span class="w"> </span><span class="n">FIRST</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">FIBONACCI</span><span class="w"> </span><span class="n">NUMBERS</span>
<span class="n">C</span>
<span class="w">      </span><span class="kt">INTEGER </span><span class="n">N</span>
<span class="w">      </span><span class="kt">REAL</span><span class="o">*</span><span class="mi">8</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">Cf2py</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="n">n</span>
<span class="n">Cf2py</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="n">a</span>
<span class="n">Cf2py</span><span class="w"> </span><span class="n">depend</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="n">a</span>
<span class="w">      </span><span class="k">DO </span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span>
<span class="w">         </span><span class="k">ELSEIF</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0D0</span>
<span class="w">         </span><span class="k">ELSE</span>
<span class="k">            </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="w">         </span><span class="k">ENDIF</span>
<span class="k">      ENDDO</span>
<span class="k">      END</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">f2py3</span>  <span class="o">-</span><span class="n">c</span> <span class="n">fib3</span><span class="o">.</span><span class="n">f</span> <span class="o">-</span><span class="n">m</span> <span class="n">fib3</span> <span class="mi">1</span><span class="o">&amp;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fib3</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fib3</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">a = fib(n)

Wrapper for <code class="docutils literal notranslate"><span class="pre">fib</span></code>.

Parameters
----------
n : input int

Returns
-------
a : rank-1 array('d') with bounds (n)</pre>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fib2</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">a = fib(n)

Wrapper for <code class="docutils literal notranslate"><span class="pre">fib</span></code>.

Parameters
----------
n : input int

Returns
-------
a : rank-1 array('d') with bounds (n)</pre>
<p>como vemos, son exactamente iguales.</p>
</section>
<section id="f2py-para-codigo-en-c">
<h3>F2PY para código en C<a class="headerlink" href="#f2py-para-codigo-en-c" title="Link to this heading"></a></h3>
<p>Es posible usar F2PY para código escrito en C, pero en ese caso debemos
escribir el <em>signature file</em> a mano.</p>
<p>Para código en C es conveniente utilizar <strong>Cython</strong>. Cython es un
lenguaje de programación pensado para hacer más fácil escribir
extensiones a Python en C. Uno escribe el código en Cython, y luego es
traducido a C, con optimizaciones.</p>
<p><strong>Cython</strong> también puede utilizarse con Fortran de una manera similar a
cómo se usa con C. Para más información ver la <a class="reference external" href="http://docs.cython.org/en/latest/index.html">documentación
oficial</a></p>
</section>
</section>
<section id="interfaces-con-otros-lenguajes-c">
<h2>Interfaces con otros lenguajes: C<a class="headerlink" href="#interfaces-con-otros-lenguajes-c" title="Link to this heading"></a></h2>
<p>Existen varias formas de utilizar bibliotecas o códigos hechos en C
desde Python. Nosotros veremos el uso de <code class="docutils literal notranslate"><span class="pre">Ctypes</span></code>, sin embargo existen
otras alternativas como <a class="reference external" href="https://cython.org/">Cython</a>,
<a class="reference external" href="https://cffi.readthedocs.io/en/latest/">CFFI</a>,
<a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11</a> y
<a class="reference external" href="https://www.boost.org/doc/libs/1_70_0/libs/python/doc/html/index.html">Boost.Python</a>.</p>
<p>Seguimos con el ejemplo de la rotación de vectores. Por completitud,
agregamos la funciones en Python para comparar</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pwd</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;/home/fiol/Clases/IntPython/clases-python/clases&#39;</span>
</pre></div>
</div>
<p>Si ya tenemos un módulo donde están programadas las funciones necesarias</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
  <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span> <span class="o">*</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">*</span> <span class="n">sy</span>

  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sy</span> <span class="o">*</span> <span class="n">sz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sy</span> <span class="o">*</span> <span class="n">cz</span>
  <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span>
  <span class="k">return</span> <span class="n">R</span>


<span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Ángulos de Euler</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># Definimos N vectores tridimensionales</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># y= rotp.rotate(angle, v)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">0.58546738</span> <span class="mf">0.89120506</span> <span class="mf">0.36725088</span><span class="p">]</span>
<span class="p">[[</span> <span class="mf">0.57382166</span>  <span class="mf">0.36547642</span>  <span class="mf">0.42691154</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">1.20276102</span>  <span class="mf">0.38198882</span>  <span class="mf">0.35784136</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.3032189</span>   <span class="mf">0.17018825</span> <span class="o">-</span><span class="mf">0.15835914</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.69480807</span>  <span class="mf">0.1054089</span>  <span class="o">-</span><span class="mf">0.15883335</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">1.36627837</span>  <span class="mf">0.1736621</span>   <span class="mf">0.17036402</span><span class="p">]]</span>
</pre></div>
</div>
<p>Veamos cómo trabajar si tenemos el código para realizar las rotaciones
en C.</p>
<section id="id1">
<h3>Primer ejemplo: Nuestro código<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>El código en C que tenemos es:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">m3x3</span><span class="p">;</span>

<span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">v3</span><span class="p">;</span>

<span class="p">...</span>

<span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rotate</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">angles</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">){</span>

<span class="w">        </span><span class="n">m3x3</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix_rotation</span><span class="p">(</span><span class="n">angles</span><span class="p">);</span>

<span class="w">        </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">N</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="w">        </span><span class="n">v3</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">            </span><span class="c1">// p = &amp;y[i*3];</span>
<span class="w">            </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matmul3</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">            </span><span class="c1">// printf(&quot;%6.3f %6.3f %6.3f \n&quot;,y[i*3+0],y[i*3+1],y[i*3+2]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>


<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">../</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_C</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">fiol</span><span class="o">/</span><span class="n">Clases</span><span class="o">/</span><span class="n">IntPython</span><span class="o">/</span><span class="n">clases</span><span class="o">-</span><span class="n">python</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_C</span>
</pre></div>
</div>
</section>
<section id="ctypes">
<h3>CTypes<a class="headerlink" href="#ctypes" title="Link to this heading"></a></h3>
<p>No vamos a usar directamente <code class="docutils literal notranslate"><span class="pre">Ctypes</span></code>, sino a través de <code class="docutils literal notranslate"><span class="pre">NumPy</span></code>, que
provee algunas funciones convenientes para acceder al código C.</p>
<p>El primer paso es compilar nuestro código y generar una biblioteca:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-fpic<span class="w"> </span>-Wall<span class="w"> </span>-shared<span class="w"> </span>rotacion.c<span class="w"> </span>-o<span class="w"> </span>librotacion.so
</pre></div>
</div>
<p>Si uno trabaja en Windows con <a class="reference external" href="https://visualstudio.microsoft.com/es/vs/features/cplusplus/">MS
C++</a>,
generará una dll</p>
<div class="highlight-cmd notranslate"><div class="highlight"><pre><span></span>cl.exe -c rotacion.c
link.exe /DLL /OUT:rotacion.dll
</pre></div>
</div>
<p>Si en cambio <a class="reference external" href="https://www.msys2.org/">instaló gcc</a>, puede usar el
comando previo.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">gcc</span> <span class="o">-</span><span class="n">fpic</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">shared</span> <span class="n">rotacion</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">librotacion</span><span class="o">.</span><span class="n">so</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">ls</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">librotacion</span><span class="o">.</span><span class="n">so</span>      <span class="n">rotacion</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
<p>En segundo lugar, importamos el módulo <code class="docutils literal notranslate"><span class="pre">ctypeslib</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy.ctypeslib</span> <span class="k">as</span> <span class="nn">ctl</span>
</pre></div>
</div>
<p>Este módulo nos provee de la función <code class="docutils literal notranslate"><span class="pre">load_library</span></code> para importar la
biblioteca</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">ctl</span><span class="o">.</span><span class="n">load_library</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">Help on function load_library in module numpy.ctypeslib:

load_library(libname, loader_path)
    It is possible to load a library using

    &gt;&gt;&gt; lib = ctypes.cdll[&lt;full_path_name&gt;] # doctest: +SKIP

    But there are cross-platform considerations, such as library file extensions,
    plus the fact Windows will just load the first library it finds with that name.
    NumPy supplies the load_library function as a convenience.

    .. versionchanged:: 1.20.0
        Allow libname and loader_path to take any
        <span class="xref std std-term">python:path-like object</span>.

    Parameters
    ----------
    libname : path-like
        Name of the library, which can have 'lib' as a prefix,
        but without an extension.
    loader_path : path-like
        Where the library can be found.

    Returns
    -------
    ctypes.cdll[libpath] : library object
       A ctypes library object

    Raises
    ------
    OSError
        If there is no library with the expected extension, or the
        library is defective and cannot be loaded.</pre>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rotc</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="s1">&#39;librotacion.so&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Una vez cargada la biblioteca, tenemos que definir adecuadamente cómo
pasar los argumentos a la función <code class="docutils literal notranslate"><span class="pre">rotate</span></code> de C:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rotate</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">angles</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
<p>Para eso se utiliza la función <code class="docutils literal notranslate"><span class="pre">argtypes</span></code> que recibe una lista de
tipos. Notemos que los dos primeros argumentos son arreglos de C (o sea,
punteros), mientras que el último es un entero.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">npflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">]</span>   <span class="c1"># Require a C contiguous array in memory</span>

<span class="n">float_1d_type</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">npflags</span><span class="p">)</span> <span class="c1"># Puntero a float, 1D</span>
<span class="n">float_2d_type</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">npflags</span><span class="p">)</span> <span class="c1"># Puntero a float, 2D</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">float_1d_type</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_ctypes</span><span class="o">.</span><span class="n">PyCSimpleType</span>
</pre></div>
</div>
<p>Con estos tipos de datos, defino los tipos de argumentos, que son tres
en total. El último es un dato de tipo entero, para lo cual se usa
directamente <code class="docutils literal notranslate"><span class="pre">c_intp</span></code>. Para definir el tipo de argumentos de entrada a
la función <code class="docutils literal notranslate"><span class="pre">rotc.rotate</span></code> usamos el método <code class="docutils literal notranslate"><span class="pre">argtypes</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rotc</span><span class="o">.</span><span class="n">rotate</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span>  <span class="p">[</span><span class="n">float_1d_type</span><span class="p">,</span> <span class="n">float_2d_type</span><span class="p">,</span> <span class="n">ctl</span><span class="o">.</span><span class="n">c_intp</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">rotc</span><span class="o">.</span><span class="n">rotate</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Help</span> <span class="n">on</span> <span class="n">_FuncPtr</span> <span class="ow">in</span> <span class="n">module</span> <span class="n">ctypes</span> <span class="nb">object</span><span class="p">:</span>

<span class="n">rotate</span> <span class="o">=</span> <span class="k">class</span> <span class="nc">_FuncPtr</span><span class="p">(</span><span class="n">_ctypes</span><span class="o">.</span><span class="n">CFuncPtr</span><span class="p">)</span>
 <span class="o">|</span>  <span class="n">Method</span> <span class="n">resolution</span> <span class="n">order</span><span class="p">:</span>
 <span class="o">|</span>      <span class="n">_FuncPtr</span>
 <span class="o">|</span>      <span class="n">_ctypes</span><span class="o">.</span><span class="n">CFuncPtr</span>
 <span class="o">|</span>      <span class="n">_ctypes</span><span class="o">.</span><span class="n">_CData</span>
 <span class="o">|</span>      <span class="n">builtins</span><span class="o">.</span><span class="n">object</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="n">Data</span> <span class="n">descriptors</span> <span class="n">defined</span> <span class="n">here</span><span class="p">:</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="vm">__dict__</span>
 <span class="o">|</span>      <span class="n">dictionary</span> <span class="k">for</span> <span class="n">instance</span> <span class="n">variables</span> <span class="p">(</span><span class="k">if</span> <span class="n">defined</span><span class="p">)</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="vm">__weakref__</span>
 <span class="o">|</span>      <span class="nb">list</span> <span class="n">of</span> <span class="n">weak</span> <span class="n">references</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">object</span> <span class="p">(</span><span class="k">if</span> <span class="n">defined</span><span class="p">)</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="o">----------------------------------------------------------------------</span>
 <span class="o">|</span>  <span class="n">Methods</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">_ctypes.CFuncPtr</span><span class="p">:</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span>
 <span class="o">|</span>      <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span> <span class="k">else</span> <span class="kc">False</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
 <span class="o">|</span>      <span class="n">Call</span> <span class="bp">self</span> <span class="k">as</span> <span class="n">a</span> <span class="n">function</span><span class="o">.</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span>
 <span class="o">|</span>      <span class="n">Return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="o">----------------------------------------------------------------------</span>
 <span class="o">|</span>  <span class="n">Static</span> <span class="n">methods</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">_ctypes.CFuncPtr</span><span class="p">:</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="fm">__new__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">_ctypes.PyCFuncPtrType</span>
 <span class="o">|</span>      <span class="n">Create</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">a</span> <span class="n">new</span> <span class="nb">object</span><span class="o">.</span>  <span class="n">See</span> <span class="n">help</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span> <span class="k">for</span> <span class="n">accurate</span> <span class="n">signature</span><span class="o">.</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="o">----------------------------------------------------------------------</span>
 <span class="o">|</span>  <span class="n">Data</span> <span class="n">descriptors</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">_ctypes.CFuncPtr</span><span class="p">:</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="n">argtypes</span>
 <span class="o">|</span>      <span class="n">specify</span> <span class="n">the</span> <span class="n">argument</span> <span class="n">types</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="n">errcheck</span>
 <span class="o">|</span>      <span class="n">a</span> <span class="n">function</span> <span class="n">to</span> <span class="n">check</span> <span class="k">for</span> <span class="n">errors</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="n">restype</span>
 <span class="o">|</span>      <span class="n">specify</span> <span class="n">the</span> <span class="n">result</span> <span class="nb">type</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="o">----------------------------------------------------------------------</span>
 <span class="o">|</span>  <span class="n">Methods</span> <span class="n">inherited</span> <span class="kn">from</span> <span class="nn">_ctypes._CData</span><span class="p">:</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="n">__ctypes_from_outparam__</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span>
 <span class="o">|</span>      <span class="n">Return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="n">__reduce__</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
 <span class="o">|</span>      <span class="n">Helper</span> <span class="k">for</span> <span class="n">pickle</span><span class="o">.</span>
 <span class="o">|</span>
 <span class="o">|</span>  <span class="n">__setstate__</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>Hagamos un ejemplo sencillo con N=2</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># Ángulos de Euler</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="c1"># Definimos N vectores tridimensionales</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
<p>Las funciones que dispongo en C reciben tipos <code class="docutils literal notranslate"><span class="pre">float</span></code>, es decir que me
tengo que asegurar esto a través del método <code class="docutils literal notranslate"><span class="pre">astype</span></code>.</p>
<p>Ahora tenemos que definir el tipo de dato de salida, que retorna C a
través de un puntero a float, <code class="docutils literal notranslate"><span class="pre">float*</span></code>. Para esto usamos el método
<code class="docutils literal notranslate"><span class="pre">restype</span></code>. Como a priori no sé qué tipo de rango tiene mi arreglo de
salida, tengo que definirlo explícitamente.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rotc</span><span class="o">.</span><span class="n">rotate</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>Hay que tener precaución con el manejo de arreglos, que es muy distinto
en C y Python. En Python son objetos, de los cuales yo puedo tener
distintas vistas, slices, etc. Hay que recordar que en principio estas
son formas de acceder al mismo objeto, pero no se pueden traducir
directamente a C, que necesita un arreglo contiguo de datos.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">vt</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="mf">1.</span> <span class="mf">0.</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.</span> <span class="mf">1.</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.</span> <span class="mf">0.</span><span class="p">]]</span>
<span class="p">[[</span><span class="mf">1.</span> <span class="mf">0.</span> <span class="mf">0.</span><span class="p">]</span>
 <span class="p">[</span><span class="mf">0.</span> <span class="mf">1.</span> <span class="mf">0.</span><span class="p">]]</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>Veamos, v es un arreglo de 3 filas y 2 columnas, que contiene <em>dos</em>
vectores de tres dimensiones que se desean rotar, organizados como
columnas. Esto <em>no</em> es lo que necesita mi arreglo en C, que es tiene los
vectores organizados contiguamente en un solo arreglo unidimensional.
Entonces, tengo que transformarlo. Para eso usamos el <code class="docutils literal notranslate"><span class="pre">.T</span></code>. Ojo que
además, hay que crear un objeto nuevo con <code class="docutils literal notranslate"><span class="pre">copy()</span></code>, sino es una vista
del mismo objeto <code class="docutils literal notranslate"><span class="pre">v</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">angle90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">angle90</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">0.</span>        <span class="mf">0.</span>        <span class="mf">1.5707964</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">yf</span> <span class="o">=</span> <span class="n">rotc</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">angle90</span><span class="p">,</span>
                      <span class="n">vt</span><span class="p">,</span>
                      <span class="n">N</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">angle90</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># suppress controla cómo print va a escribir los números de punto flotante.</span>

<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yf</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">yf</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="o">-</span><span class="mf">0.00000004</span>  <span class="mf">1.</span>        <span class="p">]</span>
 <span class="p">[</span><span class="o">-</span><span class="mf">1.</span>         <span class="o">-</span><span class="mf">0.00000004</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.</span>          <span class="mf">0.</span>        <span class="p">]]</span>
<span class="p">[[</span><span class="o">-</span><span class="mf">0.00000004</span>  <span class="mf">1.</span>        <span class="p">]</span>
 <span class="p">[</span><span class="o">-</span><span class="mf">1.</span>         <span class="o">-</span><span class="mf">0.00000004</span><span class="p">]</span>
 <span class="p">[</span> <span class="mf">0.</span>          <span class="mf">0.</span>        <span class="p">]]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kc">True</span>
</pre></div>
</div>
</section>
</section>
<section id="interfaces-con-clases-en-c">
<h2>Interfaces con clases en C++<a class="headerlink" href="#interfaces-con-clases-en-c" title="Link to this heading"></a></h2>
<p>El ejemplo original está
<a class="reference external" href="https://stackoverflow.com/questions/602580/how-can-i-use-c-class-in-python">acá</a>
que sigue <a class="reference external" href="https://www.auctoris.co.uk/2017/04/29/calling-c-classes-from-python-with-ctypes/">este
ejemplo</a>:</p>
<p>El código en C++ que tenemos es:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Test</span><span class="p">{</span>
<span class="w">     </span><span class="k">private</span><span class="o">:</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">     </span><span class="k">public</span><span class="o">:</span>
<span class="w">        </span><span class="n">Test</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">){</span>
<span class="w">            </span><span class="n">n</span><span class="o">=</span><span class="n">k</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">setInt</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">){</span>
<span class="w">            </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">getInt</span><span class="p">(){</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">../</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_Cpp</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">fiol</span><span class="o">/</span><span class="n">Clases</span><span class="o">/</span><span class="n">IntPython</span><span class="o">/</span><span class="n">clases</span><span class="o">-</span><span class="n">python</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">interfacing_Cpp</span>
</pre></div>
</div>
<p>La implementación de Python que estamos usando está escrita en C, de
modo tal que tenemos que exportar las funciones de la clase <code class="docutils literal notranslate"><span class="pre">Test</span></code> en
C++ en el código fuente de la siguiente manera:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// include below each method you want to make visible outside</span>
<span class="w">    </span><span class="n">Test</span><span class="o">*</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Test</span><span class="p">(</span><span class="n">k</span><span class="p">);}</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setInt</span><span class="p">(</span><span class="n">Test</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">setInt</span><span class="p">(</span><span class="n">k</span><span class="p">);}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">getInt</span><span class="p">(</span><span class="n">Test</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="o">-&gt;</span><span class="n">getInt</span><span class="p">();}</span>

<span class="w">    </span><span class="c1">// Add the declaration &#39;__declspec(dllexport)&#39; before each function in Windows</span>
<span class="p">}</span>
</pre></div>
</div>
<p>La declaración <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C&quot;</span></code> indican al compilador de C++ que genere
código compatible con C de todas las funciones incluídas en el bloque.</p>
<section id="id10">
<h3>CTypes<a class="headerlink" href="#id10" title="Link to this heading"></a></h3>
<p>Vamos ahora a usar directamente <code class="docutils literal notranslate"><span class="pre">Ctypes</span></code>. Como antes, el primer paso
es compilar nuestro código y generar una biblioteca:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>g++<span class="w"> </span>-fpic<span class="w"> </span>-shared<span class="w"> </span>test.cpp<span class="w"> </span>-o<span class="w"> </span>libtest.so
</pre></div>
</div>
<p>Si uno trabaja en Windows, generará una dll</p>
<div class="highlight-cmd notranslate"><div class="highlight"><pre><span></span>cl.exe -c test.cpp
link.exe /DLL /OUT:test.dll
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># !gcc -fpic -Wall -shared rotacion.c -o librotacion.so</span>
<span class="err">!</span><span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">fpic</span> <span class="o">-</span><span class="n">shared</span> <span class="n">test</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">o</span> <span class="n">libtest</span><span class="o">.</span><span class="n">so</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">ls</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libtest</span><span class="o">.</span><span class="n">so</span>  <span class="n">test</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p>En segundo lugar, importamos el módulo <code class="docutils literal notranslate"><span class="pre">ctypes</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ctypes</span>
</pre></div>
</div>
<p>Este módulo nos provee de la función <code class="docutils literal notranslate"><span class="pre">CDLL</span></code> para importar la
biblioteca</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s1">&#39;./libtest.so&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Ahora vamos a crear una clase en Python equivalente a la que teníamos en
C++. Al igual que en el caso de C, tenemos que establecer los tipos de
datos de entrada (via el método <code class="docutils literal notranslate"><span class="pre">argtypes</span></code>) y salida (vía el método
<code class="docutils literal notranslate"><span class="pre">restype</span></code>) para <em>cada función de la clase</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Test</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Declare input and output types for each method you intend to use</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>

        <span class="n">lib</span><span class="o">.</span><span class="n">setInt</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">]</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">setInt</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span>

        <span class="n">lib</span><span class="o">.</span><span class="n">getInt</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">]</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">getInt</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>

        <span class="c1"># use the C++ constructor to build the instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setInt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">setInt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getInt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lib</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">T1</span> <span class="o">=</span> <span class="n">Test</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">T1</span><span class="o">.</span><span class="n">getInt</span><span class="p">())</span>
<span class="n">T1</span><span class="o">.</span><span class="n">setInt</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">T1</span><span class="o">.</span><span class="n">getInt</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">12</span>
<span class="mi">32</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">T1</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Derechos de autor IB - 2025, Juan Fiol.</p>
  </div>

  Compilado con <a href="https://www.sphinx-doc.org/">Sphinx</a> usando un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">tema</a>
    proporcionado por <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>